<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Atendimento - CRM</title>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.body.innerHTML = '<div style="padding:20px;color:red;"><h1>Erro JavaScript</h1><p>' + msg + '</p><p>Linha: ' + line + '</p></div>';
            return false;
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f4ff', 100: '#e0e7ff', 500: '#1e3a5f', 600: '#162d4d', 700: '#0f1f33' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { height: 100vh; overflow: hidden; background-color: #f8fafc; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .chat-scroll { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        
        .msg-in { 
            background-color: #ffffff; 
            color: #1f2937;
            align-self: flex-start; 
            border-radius: 4px 16px 16px 16px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        .msg-out { 
            background-color: #dcfce7 !important;
            color: #14532d !important;
            align-self: flex-end; 
            border-radius: 16px 4px 16px 16px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
        .msg-out p, .msg-out span { color: #14532d !important; }
        .msg-out .msg-time { color: #166534 !important; }
        .msg-out a { color: #15803d !important; text-decoration: underline; }
        
        .chat-item { transition: all 0.15s ease; }
        .chat-item:hover { background-color: #f1f5f9; }
        .chat-item.active { background-color: #e0e7ff; border-left: 3px solid #1e3a5f; }
        
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0.625rem 1.25rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            border-radius: 0.75rem; 
            transition: all 0.15s ease; 
            gap: 0.5rem; 
        }
        .btn-primary { background-color: #1e3a5f; color: white; }
        .btn-primary:hover { background-color: #162d4d; }
        .btn-secondary { background-color: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background-color: #e2e8f0; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        
        .input { 
            width: 100%; 
            padding: 0.625rem 1rem; 
            font-size: 0.875rem; 
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            background: white; 
            transition: all 0.15s ease; 
        }
        .input:focus { 
            outline: none; 
            border-color: #1e3a5f; 
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1); 
        }
        
        .card { 
            background: white; 
            border-radius: 1rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); 
            border: 1px solid #f1f5f9; 
        }
        
        .badge { 
            padding: 0.25rem 0.625rem; 
            border-radius: 9999px; 
            font-size: 0.7rem; 
            font-weight: 500; 
        }
        .badge-success { background-color: #ecfdf5; color: #059669; }
        .badge-warning { background-color: #fffbeb; color: #d97706; }
        .badge-danger { background-color: #fef2f2; color: #dc2626; }
        .badge-info { background-color: #eff6ff; color: #2563eb; }
        
        .modal-overlay { 
            background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(4px); 
        }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-connected { background-color: #10b981; }
        .status-disconnected { background-color: #ef4444; }
        
        .chat-bg {
            background-color: #f1f5f9;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .group-icon {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        
        .community-icon {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }
        
        .filter-tab-active {
            background-color: white !important;
            color: #334155 !important;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        
        /* Esconder scrollbar horizontal nas abas */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Anima√ß√£o de pulse para conex√£o */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        /* Status de conex√£o colorido */
        .connection-connected { background-color: #10b981; }
        .connection-connecting { background-color: #f59e0b; animation: pulse-dot 1s ease-in-out infinite; }
        .connection-disconnected { background-color: #ef4444; }
        .connection-error { background-color: #ef4444; }
        
        /* Toolbar buttons hover */
        .toolbar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Notes panel animation */
        #notesPanel.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">

    <!-- Barra de Alerta de Conex√£o (aparece quando desconectado) -->
    <div id="connectionAlert" class="hidden bg-red-500 text-white px-4 py-2 text-center text-sm font-medium">
        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>
        <span id="connectionAlertText">WhatsApp desconectado</span>
        <button onclick="forceReconnect()" class="ml-4 bg-white text-red-600 px-3 py-1 rounded text-xs font-semibold hover:bg-red-50">
            Reconectar
        </button>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-100 h-16 flex items-center justify-between px-6 z-10">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-primary-500 flex items-center justify-center">
                    <i data-lucide="briefcase" class="w-5 h-5 text-white"></i>
                </div>
                <span class="font-bold text-lg text-slate-800">CRM</span>
            </a>
            <div class="w-px h-6 bg-slate-200"></div>
            <nav class="flex items-center gap-1">
                <a href="index.html" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-100 transition-colors">
                    <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>Dashboard
                </a>
                <a href="anny.html" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-100 transition-colors">
                    <i data-lucide="sparkles" class="w-4 h-4 inline mr-1"></i>Anny BI
                </a>
            </nav>
            <div class="w-px h-6 bg-slate-200"></div>
            <!-- Abas Conversas / Campanhas -->
            <div class="flex items-center bg-slate-100 p-1 rounded-lg">
                <button onclick="switchView('chats')" id="tabChats" class="px-4 py-2 rounded-md text-sm font-medium bg-white text-emerald-700 shadow-sm transition-colors">
                    <i data-lucide="message-circle" class="w-4 h-4 inline mr-1"></i>Conversas
                </button>
                <button onclick="switchView('campaigns')" id="tabCampaigns" class="px-4 py-2 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-colors">
                    <i data-lucide="megaphone" class="w-4 h-4 inline mr-1"></i>Campanhas
                </button>
            </div>
            <div class="w-px h-6 bg-slate-200"></div>
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-emerald-100 flex items-center justify-center">
                    <i data-lucide="message-circle" class="w-5 h-5 text-emerald-600"></i>
                </div>
                <div>
                    <h1 class="font-semibold text-slate-800">Central de Atendimento</h1>
                    <p class="text-xs text-slate-400">WhatsApp integrado</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Status de Conex√£o Melhorado -->
            <div id="connectionStatus" class="flex items-center gap-2 px-4 py-2 rounded-xl cursor-pointer hover:bg-slate-50 transition" onclick="showConnectionDetails()">
                <div id="connectionDot" class="w-3 h-3 rounded-full bg-slate-400 animate-pulse"></div>
                <div class="flex flex-col">
                    <span id="connectionText" class="text-sm font-medium text-slate-600">Verificando...</span>
                    <span id="connectionSubtext" class="text-[10px] text-slate-400 hidden">√öltima verifica√ß√£o: agora</span>
                </div>
            </div>
            <button onclick="disconnectWhatsapp()" class="btn btn-secondary text-sm py-2 text-red-600 hover:bg-red-50" title="Desconectar WhatsApp atual">
                <i data-lucide="log-out" class="w-4 h-4"></i>
            </button>
            <button onclick="connectWhatsapp()" id="btnConnect" class="btn btn-primary text-sm py-2">
                <i data-lucide="plug" class="w-4 h-4" id="connectIcon"></i>
                <span id="connectText">Conectar</span>
            </button>
        </div>
    </header>

    <!-- Layout 3 Colunas - VIEW CONVERSAS -->
    <main id="viewChats" class="flex-1 flex overflow-hidden">
        
        <!-- Coluna 1: Lista de Chats -->
        <aside class="w-80 bg-white border-r border-slate-100 flex flex-col">
            <div class="p-3 border-b border-slate-100">
                <div class="flex gap-2 mb-3">
                    <div class="relative flex-1">
                        <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="searchChats" placeholder="Buscar conversa..." class="input pl-10 text-sm" oninput="searchChatsFilter(this.value)">
                    </div>
                    <button onclick="loadChats()" class="btn btn-secondary px-3" title="Atualizar Conversas">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <!-- ABAS INTELIGENTES - Estilo Extens√£o -->
                <div class="flex overflow-x-auto gap-1 pb-1 -mx-1 px-1 scrollbar-hide">
                    <button onclick="filterChats('all')" id="filterAll" class="filter-tab flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all bg-emerald-500 text-white">
                        <span>Todos</span>
                        <span id="countAll" class="bg-white/20 text-white px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </button>
                    <button onclick="filterChats('unread')" id="filterUnread" class="filter-tab flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                        <i data-lucide="mail" class="w-3 h-3"></i>
                        <span>N√£o Lidos</span>
                        <span id="countUnread" class="bg-red-500 text-white px-1.5 py-0.5 rounded text-[10px] hidden">0</span>
                    </button>
                    <button onclick="filterChats('waiting')" id="filterWaiting" class="filter-tab flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        <span>Aguardando</span>
                        <span id="countWaiting" class="bg-amber-500 text-white px-1.5 py-0.5 rounded text-[10px] hidden">0</span>
                    </button>
                    <button onclick="filterChats('groups')" id="filterGroups" class="filter-tab flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                        <i data-lucide="users" class="w-3 h-3"></i>
                        <span>Grupos</span>
                        <span id="countGroups" class="bg-blue-500 text-white px-1.5 py-0.5 rounded text-[10px] hidden">0</span>
                    </button>
                    <button onclick="filterChats('sales')" id="filterSales" class="filter-tab flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap transition-all bg-slate-100 text-slate-600 hover:bg-slate-200">
                        <i data-lucide="shopping-bag" class="w-3 h-3"></i>
                        <span>Vendas</span>
                        <span id="countSales" class="bg-emerald-500 text-white px-1.5 py-0.5 rounded text-[10px] hidden">0</span>
                    </button>
                </div>
                
                <!-- Filtros Adicionais -->
                <div class="flex gap-1 flex-wrap mt-2">
                    <button onclick="filterChats('vacuum')" id="filterVacuum" class="flex items-center gap-1 px-2 py-1 rounded text-[10px] font-medium transition-colors text-red-600 hover:bg-red-50 border border-red-200" title="Sem resposta h√° mais de 4h">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i>V√°cuo
                        <span id="countVacuum" class="hidden bg-red-100 text-red-600 px-1 rounded">0</span>
                    </button>
                    <button onclick="filterChats('snoozed')" id="filterSnoozed" class="flex items-center gap-1 px-2 py-1 rounded text-[10px] font-medium transition-colors text-amber-600 hover:bg-amber-50 border border-amber-200" title="Conversas adiadas">
                        <i data-lucide="alarm-clock" class="w-3 h-3"></i>Adiados
                    </button>
                    <button onclick="openTagFilterModal()" id="filterByTag" class="flex items-center gap-1 px-2 py-1 rounded text-[10px] font-medium transition-colors text-blue-600 hover:bg-blue-50 border border-blue-200" title="Filtrar por etiqueta">
                        <i data-lucide="tag" class="w-3 h-3"></i>Tags
                    </button>
                </div>
            </div>
            <div id="chatsList" class="flex-1 overflow-y-auto chat-scroll">
                <div class="p-8 text-center">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="message-square" class="w-6 h-6 text-slate-400"></i>
                    </div>
                    <p class="text-sm text-slate-500">Carregando conversas...</p>
                </div>
            </div>
        </aside>

        <!-- Coluna 2: Chat Ativo -->
        <section class="flex-1 flex flex-col chat-bg relative">
            <!-- Header do Chat -->
            <div id="chatHeader" class="h-16 bg-white border-b border-slate-100 flex items-center px-5 justify-between hidden">
                <div class="flex items-center gap-3 flex-1 cursor-pointer hover:bg-slate-50 -mx-2 px-2 py-2 rounded-lg transition" onclick="openClientSidebar()" title="Clique para ver/editar dados do contato">
                    <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-semibold text-sm relative overflow-hidden">
                        <img id="headerAvatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover hidden">
                        <span id="headerInitials">?</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 id="headerName" class="font-semibold text-slate-800 truncate">Nome</h2>
                        <div class="flex items-center gap-2">
                            <p id="headerNumber" class="text-xs text-slate-500 truncate">+55 00 0000-0000</p>
                            <a id="headerWhatsAppLink" href="#" target="_blank" class="text-emerald-600 hover:text-emerald-700 transition hidden" title="Abrir no WhatsApp" onclick="event.stopPropagation()">
                                <i data-lucide="message-circle" class="w-3.5 h-3.5"></i>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- √Årea de Tags -->
                <div class="flex items-center gap-2">
                    <div id="chatTags" class="flex gap-1 flex-wrap max-w-[200px]"></div>
                    <button onclick="openTagsModal()" class="btn btn-secondary text-xs py-1.5 px-2" title="Gerenciar etiquetas">
                        <i data-lucide="tag" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="openSnoozeModal()" class="btn btn-secondary text-xs py-1.5 px-2" title="Adiar conversa">
                        <i data-lucide="alarm-clock" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <button onclick="openQuickReplies()" class="btn btn-secondary text-sm py-2" title="Mensagens r√°pidas">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                    </button>
                    <button onclick="openProductModal()" class="btn btn-primary text-sm py-2">
                        <i data-lucide="package" class="w-4 h-4"></i>
                        Produtos
                    </button>
                </div>
            </div>

            <!-- √Årea de Mensagens -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto p-6 flex flex-col gap-3 chat-scroll">
                <div class="flex h-full items-center justify-center">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full bg-white shadow-sm flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="message-circle" class="w-8 h-8 text-slate-300"></i>
                        </div>
                        <p class="text-slate-500 font-medium">Selecione uma conversa</p>
                        <p class="text-sm text-slate-400 mt-1">As mensagens aparecer√£o aqui</p>
                    </div>
                </div>
            </div>

            <!-- TOOLBAR DO CHAT - Nova barra de ferramentas -->
            <div id="chatToolbar" class="bg-slate-50 border-t border-slate-200 px-4 py-2 hidden">
                <div class="flex items-center gap-2 overflow-x-auto">
                    <button onclick="openQuickReplies()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 transition whitespace-nowrap">
                        <i data-lucide="zap" class="w-3.5 h-3.5 text-amber-500"></i>
                        <span>Respostas R√°pidas</span>
                    </button>
                    <button onclick="openScheduleModal()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 transition whitespace-nowrap">
                        <i data-lucide="calendar" class="w-3.5 h-3.5 text-blue-500"></i>
                        <span>Agendar</span>
                    </button>
                    <button onclick="toggleNotesPanel()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 transition whitespace-nowrap">
                        <i data-lucide="sticky-note" class="w-3.5 h-3.5 text-yellow-500"></i>
                        <span>Notas</span>
                        <span id="notesCount" class="hidden bg-yellow-100 text-yellow-700 px-1.5 rounded text-[10px]">0</span>
                    </button>
                    <button onclick="openTagsModal()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 transition whitespace-nowrap">
                        <i data-lucide="tag" class="w-3.5 h-3.5 text-purple-500"></i>
                        <span>Tags</span>
                    </button>
                    <div class="w-px h-6 bg-slate-200"></div>
                    <button onclick="openProductModal()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-white border border-slate-200 text-slate-600 hover:bg-slate-100 hover:border-slate-300 transition whitespace-nowrap">
                        <i data-lucide="package" class="w-3.5 h-3.5 text-emerald-500"></i>
                        <span>Produtos</span>
                    </button>
                    <button onclick="markAsResolved()" class="toolbar-btn flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-emerald-50 border border-emerald-200 text-emerald-600 hover:bg-emerald-100 transition whitespace-nowrap">
                        <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                        <span>Resolvido</span>
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div id="inputArea" class="bg-white p-4 border-t border-slate-100 hidden">
                <!-- Preview de arquivo (escondido por padr√£o) -->
                <div id="filePreview" class="hidden mb-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="flex items-center gap-3">
                        <div id="filePreviewThumb" class="w-12 h-12 rounded-lg bg-slate-200 flex items-center justify-center overflow-hidden">
                            <i data-lucide="file" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="filePreviewName" class="text-sm font-medium text-slate-700 truncate">arquivo.jpg</p>
                            <p id="filePreviewSize" class="text-xs text-slate-400">1.2 MB</p>
                        </div>
                        <button onclick="clearFilePreview()" class="text-slate-400 hover:text-red-500 p-1">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <input id="fileCaption" type="text" class="input mt-2 text-sm" placeholder="Adicionar legenda (opcional)...">
                </div>
                
                <!-- Preview de √Åudio Gravado -->
                <div id="audioPreview" class="hidden mb-3 p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                    <div class="flex items-center gap-3">
                        <button onclick="playRecordedAudio()" id="btnPlayAudio" class="w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center hover:bg-emerald-600 transition-colors">
                            <i data-lucide="play" class="w-5 h-5"></i>
                        </button>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <div id="audioWavePreview" class="flex-1 h-8 bg-emerald-100 rounded flex items-center justify-center gap-0.5 overflow-hidden">
                                    <!-- Barra de progresso do √°udio -->
                                    <div id="audioProgress" class="h-full bg-emerald-400 rounded transition-all" style="width: 0%"></div>
                                </div>
                                <span id="audioDuration" class="text-sm font-medium text-emerald-700">0:00</span>
                            </div>
                        </div>
                        <button onclick="discardAudio()" class="text-red-400 hover:text-red-600 p-2" title="Descartar">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                        <button onclick="sendRecordedAudio()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg hover:bg-emerald-600 flex items-center gap-2 font-medium">
                            <i data-lucide="send" class="w-4 h-4"></i>
                            Enviar
                        </button>
                    </div>
                </div>
                
                <!-- √Årea de Grava√ß√£o (mostrada quando est√° gravando) -->
                <div id="recordingArea" class="hidden mb-3 p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-red-500 flex items-center justify-center animate-pulse">
                                <i data-lucide="mic" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-red-700">Gravando √°udio...</p>
                                <p id="recordingTimer" class="text-2xl font-bold text-red-600">0:00</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Visualizador de onda -->
                            <div id="audioVisualizer" class="flex items-center gap-0.5 h-10">
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 40%"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 70%; animation-delay: 0.1s"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 50%; animation-delay: 0.2s"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 90%; animation-delay: 0.15s"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 60%; animation-delay: 0.25s"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 80%; animation-delay: 0.1s"></div>
                                <div class="w-1 bg-red-400 rounded animate-pulse" style="height: 45%; animation-delay: 0.2s"></div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="cancelRecording()" class="px-4 py-2 bg-white text-red-600 border border-red-300 rounded-lg hover:bg-red-100 flex items-center gap-2 font-medium">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                Cancelar
                            </button>
                            <button onclick="stopAndPreviewAudio()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2 font-medium">
                                <i data-lucide="square" class="w-4 h-4"></i>
                                Parar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- √Årea de Input Normal -->
                <div id="normalInputArea" class="flex gap-3 items-center">
                    <!-- Menu de anexos -->
                    <div class="relative">
                        <button onclick="toggleAttachMenu()" class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <i data-lucide="paperclip" class="w-5 h-5"></i>
                        </button>
                        <div id="attachMenu" class="hidden absolute bottom-full left-0 mb-2 bg-white rounded-xl shadow-lg border border-slate-200 py-2 min-w-[160px]">
                            <button onclick="selectFile('image')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-3">
                                <i data-lucide="image" class="w-4 h-4 text-emerald-500"></i> Imagem
                            </button>
                            <button onclick="selectFile('video')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-3">
                                <i data-lucide="video" class="w-4 h-4 text-blue-500"></i> V√≠deo
                            </button>
                            <button onclick="selectFile('audio')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-3">
                                <i data-lucide="music" class="w-4 h-4 text-purple-500"></i> √Åudio
                            </button>
                            <button onclick="selectFile('document')" class="w-full px-4 py-2 text-left text-sm hover:bg-slate-50 flex items-center gap-3">
                                <i data-lucide="file-text" class="w-4 h-4 text-orange-500"></i> Documento
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(event)">
                    
                    <!-- Bot√£o Mensagens R√°pidas -->
                    <button onclick="openQuickReplies()" class="text-slate-400 hover:text-slate-600 p-2 rounded-lg hover:bg-slate-100 transition-colors" title="Mensagens r√°pidas (/)">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </button>
                    
                    <input id="inputMessage" type="text" class="flex-1 input" placeholder="Digite sua mensagem... (/ para atalhos)">
                    
                    <!-- Bot√£o Gravar √Åudio - Novo Design -->
                    <button onclick="startAudioRecording()" id="btnStartRecording" class="text-slate-400 hover:text-emerald-600 p-2 rounded-lg hover:bg-emerald-50 transition-colors" title="Clique para gravar √°udio">
                        <i data-lucide="mic" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="sendMessage()" class="btn btn-success px-4">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Enviar
                    </button>
                </div>
            </div>
        </section>

        <!-- Coluna 3: Dados do Cliente CRM Unificado -->
        <aside class="w-96 bg-white border-l border-slate-100 flex flex-col overflow-y-auto chat-scroll">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4 text-slate-400"></i>
                    <h3 class="font-semibold text-slate-800">Dados do Cliente</h3>
                </div>
                <button onclick="openSearchClientModal()" class="text-slate-400 hover:text-slate-600 p-1.5 rounded-lg hover:bg-slate-100" title="Buscar/Vincular cliente">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="crmDataContainer" class="flex-1 p-4 overflow-y-auto">
                <div class="text-center py-8">
                    <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="user-circle" class="w-6 h-6 text-slate-400"></i>
                    </div>
                    <p class="text-sm text-slate-500">Selecione um chat para ver os dados do cliente.</p>
                </div>
            </div>
        </aside>
    </main>

    <!-- VIEW CAMPANHAS -->
    <main id="viewCampaigns" class="flex-1 flex overflow-hidden hidden">
        <!-- Sidebar: Estat√≠sticas e Filtros -->
        <aside class="w-72 bg-white border-r border-slate-100 p-5 overflow-y-auto">
            <h3 class="font-semibold text-slate-800 mb-4">Vis√£o Geral</h3>
            
            <div class="space-y-3 mb-6">
                <div class="p-4 rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200">
                    <div class="flex items-center gap-2 text-emerald-600 mb-1">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        <span class="text-xs font-medium">Enviadas Hoje</span>
                    </div>
                    <p id="statSentToday" class="text-2xl font-bold text-emerald-700">0</p>
                </div>
                
                <div class="p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                    <div class="flex items-center gap-2 text-blue-600 mb-1">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        <span class="text-xs font-medium">Agendadas</span>
                    </div>
                    <p id="statScheduled" class="text-2xl font-bold text-blue-700">0</p>
                </div>
                
                <div class="p-4 rounded-xl bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200">
                    <div class="flex items-center gap-2 text-amber-600 mb-1">
                        <i data-lucide="play" class="w-4 h-4"></i>
                        <span class="text-xs font-medium">Em Andamento</span>
                    </div>
                    <p id="statRunning" class="text-2xl font-bold text-amber-700">0</p>
                </div>
            </div>
            
            <h3 class="font-semibold text-slate-800 mb-3">Filtrar por Status</h3>
            <div class="space-y-2">
                <button onclick="filterCampaigns('all')" id="campFilterAll" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium bg-slate-100 text-slate-700">
                    Todas
                </button>
                <button onclick="filterCampaigns('scheduled')" id="campFilterScheduled" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50">
                    <span class="w-2 h-2 rounded-full bg-amber-400 inline-block mr-2"></span>Agendadas
                </button>
                <button onclick="filterCampaigns('running')" id="campFilterRunning" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50">
                    <span class="w-2 h-2 rounded-full bg-blue-400 inline-block mr-2"></span>Em Andamento
                </button>
                <button onclick="filterCampaigns('completed')" id="campFilterCompleted" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 inline-block mr-2"></span>Conclu√≠das
                </button>
                <button onclick="filterCampaigns('paused')" id="campFilterPaused" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-500 hover:bg-slate-50">
                    <span class="w-2 h-2 rounded-full bg-slate-400 inline-block mr-2"></span>Pausadas
                </button>
            </div>
            
            <div class="mt-6 pt-6 border-t border-slate-100">
                <h3 class="font-semibold text-slate-800 mb-3">A√ß√µes R√°pidas</h3>
                <div class="space-y-2">
                    <button onclick="openImportFromGroup()" class="w-full btn btn-secondary text-xs justify-start">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        Importar de Grupo
                    </button>
                    <button onclick="selectAudience('inactive'); openNewCampaign()" class="w-full btn btn-secondary text-xs justify-start">
                        <i data-lucide="user-x" class="w-4 h-4"></i>
                        Clientes Inativos
                    </button>
                </div>
            </div>
        </aside>

        <!-- Lista de Campanhas -->
        <section class="flex-1 p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-slate-800">Minhas Campanhas</h2>
                <div class="flex gap-2">
                    <input type="text" id="searchCampaigns" placeholder="Buscar campanha..." class="input w-64" onkeyup="searchCampaigns(this.value)">
                    <button onclick="openNewCampaign()" class="btn btn-primary">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Nova Campanha
                    </button>
                </div>
            </div>
            
            <div id="campaignsList" class="space-y-4">
                <div class="text-center py-12">
                    <div class="w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="megaphone" class="w-8 h-8 text-slate-300"></i>
                    </div>
                    <p class="text-slate-500 font-medium">Nenhuma campanha criada</p>
                    <p class="text-sm text-slate-400 mt-1">Crie sua primeira campanha de disparo</p>
                    <button onclick="openNewCampaign()" class="btn btn-primary mt-4">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Nova Campanha
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Produtos -->
    <div id="productModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeProductModal()"></div>
        <div class="relative bg-white w-[600px] max-h-[80vh] rounded-2xl shadow-xl flex flex-col">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-blue-100 flex items-center justify-center">
                        <i data-lucide="package" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <h3 class="font-semibold text-slate-800">Selecionar Produtos</h3>
                </div>
                <button onclick="closeProductModal()" class="text-slate-400 hover:text-slate-600 p-1 rounded-lg hover:bg-slate-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-100">
                <div class="relative">
                    <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="productSearch" onkeyup="searchProducts(this.value)" placeholder="Buscar por nome ou SKU..." class="input pl-10 text-sm">
                </div>
            </div>
            <div id="productsListModal" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-center py-8 text-slate-500 text-sm">Carregando produtos...</div>
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end">
                <button onclick="closeProductModal()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qrModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="document.getElementById('qrModal').classList.add('hidden')"></div>
        <div class="relative bg-white p-8 rounded-2xl text-center max-w-sm w-full shadow-xl">
            <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center mx-auto mb-4">
                <i data-lucide="smartphone" class="w-6 h-6 text-emerald-600"></i>
            </div>
            <h3 class="font-semibold text-lg text-slate-800 mb-2">Conectar WhatsApp</h3>
            <p class="text-sm text-slate-500 mb-5">Escaneie o QR Code com seu WhatsApp</p>
            <div id="qrContainer" class="bg-slate-100 rounded-xl w-64 h-64 mx-auto flex items-center justify-center mb-5">
                <p class="text-sm text-slate-400">Carregando QR...</p>
            </div>
            <p class="text-xs text-slate-400 mb-5">Abra o WhatsApp > Aparelhos Conectados > Conectar Aparelho</p>
            <button onclick="document.getElementById('qrModal').classList.add('hidden')" class="btn btn-secondary w-full">
                Fechar
            </button>
        </div>
    </div>

    <!-- Modal de Etiquetas -->
    <div id="tagsModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeTagsModal()"></div>
        <div class="relative bg-white w-[400px] rounded-2xl shadow-xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-semibold text-slate-800">Etiquetas</h3>
                <button onclick="closeTagsModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4">
                <p class="text-xs text-slate-500 mb-3">Selecione as etiquetas para este contato:</p>
                <div id="tagsList" class="space-y-2 max-h-[300px] overflow-y-auto">
                    <!-- Tags ser√£o renderizadas aqui -->
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <div class="flex gap-2">
                        <input type="text" id="newTagName" placeholder="Nova etiqueta..." class="input flex-1 text-sm">
                        <select id="newTagColor" class="input w-24 text-sm">
                            <option value="#ef4444">üî¥</option>
                            <option value="#f97316">üü†</option>
                            <option value="#eab308">üü°</option>
                            <option value="#22c55e">üü¢</option>
                            <option value="#3b82f6">üîµ</option>
                            <option value="#8b5cf6">üü£</option>
                            <option value="#6b7280">‚ö´</option>
                        </select>
                        <button onclick="createTag()" class="btn btn-primary px-3">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagens R√°pidas -->
    <div id="quickRepliesModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeQuickReplies()"></div>
        <div class="relative bg-white w-[500px] max-h-[80vh] rounded-2xl shadow-xl flex flex-col">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-amber-100 flex items-center justify-center">
                        <i data-lucide="zap" class="w-5 h-5 text-amber-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Mensagens R√°pidas</h3>
                        <p class="text-xs text-slate-500">Use vari√°veis: {{nome}}, {{ultimo_pedido}}</p>
                    </div>
                </div>
                <button onclick="closeQuickReplies()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 bg-slate-50 border-b border-slate-100">
                <input type="text" id="searchQuickReply" onkeyup="filterQuickReplies(this.value)" placeholder="Buscar resposta..." class="input text-sm">
            </div>
            <div id="quickRepliesList" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Respostas ser√£o renderizadas aqui -->
            </div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl">
                <button onclick="openNewQuickReply()" class="btn btn-primary w-full">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Nova Mensagem R√°pida
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nova/Editar Mensagem R√°pida -->
    <div id="editQuickReplyModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeEditQuickReply()"></div>
        <div class="relative bg-white w-[500px] rounded-2xl shadow-xl">
            <div class="p-5 border-b border-slate-100">
                <h3 id="editQuickReplyTitle" class="font-semibold text-slate-800">Nova Mensagem R√°pida</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Atalho</label>
                    <input type="text" id="qrShortcut" placeholder="ex: ola, preco, rastreio" class="input">
                    <p class="text-xs text-slate-400 mt-1">Digite /atalho no chat para usar</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Mensagem</label>
                    <textarea id="qrMessage" rows="5" placeholder="Ol√° {{nome}}, tudo bem?" class="input resize-none"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button onclick="insertVariable('nome')" class="text-xs px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">{{nome}}</button>
                        <button onclick="insertVariable('ultimo_pedido')" class="text-xs px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">{{ultimo_pedido}}</button>
                        <button onclick="insertVariable('telefone')" class="text-xs px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">{{telefone}}</button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeEditQuickReply()" class="btn btn-secondary">Cancelar</button>
                <button onclick="saveQuickReply()" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Snooze (Soneca) -->
    <div id="snoozeModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeSnoozeModal()"></div>
        <div class="relative bg-white w-[350px] rounded-2xl shadow-xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-semibold text-slate-800">Adiar Conversa</h3>
                <button onclick="closeSnoozeModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 space-y-2">
                <button onclick="snoozeChat(1)" class="w-full p-3 text-left rounded-lg hover:bg-slate-50 flex items-center gap-3 border border-slate-200">
                    <i data-lucide="sun" class="w-5 h-5 text-amber-500"></i>
                    <div>
                        <p class="font-medium text-slate-700">Amanh√£</p>
                        <p class="text-xs text-slate-400">Reaparece √†s 09:00</p>
                    </div>
                </button>
                <button onclick="snoozeChat(3)" class="w-full p-3 text-left rounded-lg hover:bg-slate-50 flex items-center gap-3 border border-slate-200">
                    <i data-lucide="calendar" class="w-5 h-5 text-blue-500"></i>
                    <div>
                        <p class="font-medium text-slate-700">Em 3 dias</p>
                        <p class="text-xs text-slate-400">Pr√≥xima semana</p>
                    </div>
                </button>
                <button onclick="snoozeChat(7)" class="w-full p-3 text-left rounded-lg hover:bg-slate-50 flex items-center gap-3 border border-slate-200">
                    <i data-lucide="calendar-days" class="w-5 h-5 text-purple-500"></i>
                    <div>
                        <p class="font-medium text-slate-700">Em 1 semana</p>
                        <p class="text-xs text-slate-400">Daqui a 7 dias</p>
                    </div>
                </button>
                <button onclick="snoozeChat(30)" class="w-full p-3 text-left rounded-lg hover:bg-slate-50 flex items-center gap-3 border border-slate-200">
                    <i data-lucide="calendar-range" class="w-5 h-5 text-emerald-500"></i>
                    <div>
                        <p class="font-medium text-slate-700">Em 1 m√™s</p>
                        <p class="text-xs text-slate-400">Daqui a 30 dias</p>
                    </div>
                </button>
                <div class="pt-2 border-t border-slate-100 mt-2">
                    <label class="block text-xs text-slate-500 mb-1">Data personalizada:</label>
                    <input type="date" id="customSnoozeDate" class="input text-sm" onchange="snoozeCustom()">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Buscar/Vincular Cliente -->
    <div id="searchClientModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeSearchClientModal()"></div>
        <div class="relative bg-white w-[450px] max-h-[80vh] rounded-2xl shadow-xl flex flex-col">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-blue-100 flex items-center justify-center">
                        <i data-lucide="search" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Vincular Cliente</h3>
                        <p class="text-xs text-slate-500">Buscar cliente pelo nome</p>
                    </div>
                </div>
                <button onclick="closeSearchClientModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 border-b border-slate-100">
                <input type="text" id="searchClientInput" placeholder="Digite o nome do cliente..." class="input" oninput="searchClientByName(this.value)">
            </div>
            <div id="searchClientResults" class="flex-1 overflow-y-auto p-4 space-y-2 max-h-[300px]">
                <p class="text-center text-slate-400 text-sm py-4">Digite para buscar clientes...</p>
            </div>
        </div>
    </div>

    <!-- Modal Nova Campanha -->
    <div id="newCampaignModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeNewCampaign()"></div>
        <div class="relative bg-white w-[700px] max-h-[90vh] rounded-2xl shadow-xl flex flex-col">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-purple-100 flex items-center justify-center">
                        <i data-lucide="megaphone" class="w-5 h-5 text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Nova Campanha</h3>
                        <p class="text-xs text-slate-500">Configure o disparo em massa</p>
                    </div>
                </div>
                <button onclick="closeNewCampaign()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-5">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Campanha</label>
                    <input type="text" id="campaignName" placeholder="Ex: Reposi√ß√£o Janeiro" class="input">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">P√∫blico Alvo</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectAudience('all')" class="audience-btn p-4 rounded-xl border-2 border-slate-200 text-left hover:border-primary-500 transition-colors" data-audience="all">
                            <i data-lucide="users" class="w-5 h-5 text-slate-500 mb-2"></i>
                            <p class="font-medium text-slate-700">Todos os Clientes</p>
                            <p id="countAll" class="text-xs text-slate-400">0 contatos</p>
                        </button>
                        <button onclick="selectAudience('inactive')" class="audience-btn p-4 rounded-xl border-2 border-slate-200 text-left hover:border-primary-500 transition-colors" data-audience="inactive">
                            <i data-lucide="user-x" class="w-5 h-5 text-red-500 mb-2"></i>
                            <p class="font-medium text-slate-700">Inativos (90+ dias)</p>
                            <p id="countInactive" class="text-xs text-slate-400">0 contatos</p>
                        </button>
                        <button onclick="selectAudience('vip')" class="audience-btn p-4 rounded-xl border-2 border-slate-200 text-left hover:border-primary-500 transition-colors" data-audience="vip">
                            <i data-lucide="star" class="w-5 h-5 text-amber-500 mb-2"></i>
                            <p class="font-medium text-slate-700">Clientes VIP</p>
                            <p id="countVip" class="text-xs text-slate-400">Ticket > R$ 500</p>
                        </button>
                        <button onclick="selectAudience('group')" class="audience-btn p-4 rounded-xl border-2 border-slate-200 text-left hover:border-primary-500 transition-colors" data-audience="group">
                            <i data-lucide="message-circle" class="w-5 h-5 text-emerald-500 mb-2"></i>
                            <p class="font-medium text-slate-700">Grupo WhatsApp</p>
                            <p class="text-xs text-slate-400">Selecionar grupo</p>
                        </button>
                    </div>
                    <div id="groupSelector" class="hidden mt-3">
                        <select id="targetGroup" class="input">
                            <option value="">Selecione um grupo...</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Mensagem</label>
                    <textarea id="campaignMessage" rows="5" placeholder="Digite sua mensagem... Use {{nome}} para personalizar" class="input resize-none"></textarea>
                    <div class="flex gap-2 mt-2">
                        <button onclick="insertCampaignVar('nome')" class="text-xs px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">{{nome}}</button>
                        <button onclick="insertCampaignVar('cidade')" class="text-xs px-2 py-1 bg-slate-100 rounded hover:bg-slate-200">{{cidade}}</button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Imagem (opcional)</label>
                    <div id="campaignImagePreview" class="hidden mb-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <img id="campaignImageThumb" src="" class="w-20 h-20 object-cover rounded">
                        <button onclick="removeCampaignImage()" class="text-red-500 text-xs mt-1">Remover</button>
                    </div>
                    <input type="file" id="campaignImage" accept="image/*" class="input text-sm" onchange="previewCampaignImage(event)">
                </div>
                
                <div class="p-4 bg-slate-50 rounded-xl">
                    <label class="flex items-center gap-2 cursor-pointer mb-3">
                        <input type="checkbox" id="scheduleEnabled" onchange="toggleSchedule()" class="w-4 h-4 rounded">
                        <span class="text-sm font-medium text-slate-700">Agendar envio</span>
                    </label>
                    <div id="scheduleOptions" class="hidden grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Data</label>
                            <input type="date" id="scheduleDate" class="input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-500 mb-1">Hora</label>
                            <input type="time" id="scheduleTime" value="09:00" class="input">
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-blue-50 rounded-xl">
                    <div class="flex items-start gap-3">
                        <i data-lucide="shield-check" class="w-5 h-5 text-blue-500 mt-0.5"></i>
                        <div>
                            <h4 class="font-medium text-slate-800">Modo Conta-Gotas (Anti-Ban)</h4>
                            <p class="text-xs text-slate-500 mt-1">Distribui os envios em pequenos lotes para evitar bloqueio.</p>
                            <div class="mt-3 grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Mensagens por lote</label>
                                    <select id="batchSize" class="input text-sm">
                                        <option value="10">10 mensagens</option>
                                        <option value="15" selected>15 mensagens</option>
                                        <option value="20">20 mensagens</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-slate-500 mb-1">Intervalo entre lotes</label>
                                    <select id="batchInterval" class="input text-sm">
                                        <option value="15">15 minutos</option>
                                        <option value="20" selected>20 minutos</option>
                                        <option value="30">30 minutos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-5 border-t border-slate-100 flex justify-between items-center">
                <p id="campaignSummary" class="text-sm text-slate-500">Selecione o p√∫blico e a mensagem</p>
                <div class="flex gap-2">
                    <button onclick="closeNewCampaign()" class="btn btn-secondary">Cancelar</button>
                    <button onclick="saveCampaign()" class="btn btn-primary">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        Criar Campanha
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento de Mensagem -->
    <div id="scheduleModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeScheduleModal()"></div>
        <div class="relative bg-white w-[450px] rounded-2xl shadow-xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-blue-100 flex items-center justify-center">
                        <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Agendar Mensagem</h3>
                        <p class="text-xs text-slate-500">Ser√° enviada automaticamente</p>
                    </div>
                </div>
                <button onclick="closeScheduleModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Data e Hora</label>
                    <input type="datetime-local" id="scheduleDateTime" class="input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Mensagem</label>
                    <textarea id="scheduleMessage" class="input w-full h-32 resize-none" placeholder="Digite a mensagem a ser enviada..."></textarea>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                    A mensagem ser√° enviada mesmo se voc√™ n√£o estiver online.
                </div>
            </div>
            <div class="p-5 border-t border-slate-100 flex justify-end gap-2">
                <button onclick="closeScheduleModal()" class="btn btn-secondary">Cancelar</button>
                <button onclick="saveScheduledMessage()" class="btn btn-primary">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    Agendar
                </button>
            </div>
        </div>
    </div>

    <!-- Painel de Notas (Post-it lateral) -->
    <div id="notesPanel" class="fixed right-0 top-16 bottom-0 w-80 bg-yellow-50 border-l border-yellow-200 shadow-lg z-40 transform translate-x-full transition-transform duration-300">
        <div class="p-4 border-b border-yellow-200 flex justify-between items-center bg-yellow-100">
            <div class="flex items-center gap-2">
                <i data-lucide="sticky-note" class="w-5 h-5 text-yellow-600"></i>
                <h3 class="font-semibold text-yellow-800">Notas do Cliente</h3>
            </div>
            <button onclick="toggleNotesPanel()" class="text-yellow-600 hover:text-yellow-800">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-4">
            <textarea id="clientNotes" class="w-full h-64 p-3 rounded-lg border-2 border-yellow-200 bg-white focus:border-yellow-400 focus:outline-none resize-none text-sm" placeholder="Adicione anota√ß√µes sobre este cliente...

Ex: 
- Prefer√™ncia por pagamento via PIX
- Compra sempre aos s√°bados
- Sens√≠vel a pre√ßo"></textarea>
            <div class="mt-3 flex gap-2">
                <button onclick="saveClientNotes()" class="btn btn-primary flex-1 bg-yellow-500 hover:bg-yellow-600 border-0">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Salvar Notas
                </button>
            </div>
            <div class="mt-4 pt-4 border-t border-yellow-200">
                <h4 class="text-xs font-semibold text-yellow-700 mb-2">HIST√ìRICO DE NOTAS</h4>
                <div id="notesHistory" class="space-y-2 max-h-48 overflow-y-auto text-xs text-yellow-800">
                    <p class="text-slate-400 italic">Nenhuma nota anterior</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes de Conex√£o -->
    <div id="connectionDetailsModal" class="fixed inset-0 hidden z-50 flex items-center justify-center">
        <div class="fixed inset-0 modal-overlay" onclick="closeConnectionDetails()"></div>
        <div class="relative bg-white w-[500px] rounded-2xl shadow-xl">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="connectionDetailIcon" class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center">
                        <i data-lucide="wifi" class="w-5 h-5 text-slate-600"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-800">Status da Conex√£o</h3>
                        <p id="connectionDetailStatus" class="text-xs text-slate-500">Verificando...</p>
                    </div>
                </div>
                <button onclick="closeConnectionDetails()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">√öltima Verifica√ß√£o</p>
                        <p id="connectionLastCheck" class="text-sm font-semibold text-slate-700">-</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">√öltima Conex√£o</p>
                        <p id="connectionLastConnected" class="text-sm font-semibold text-slate-700">-</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Tentativas de Reconex√£o</p>
                        <p id="connectionAttempts" class="text-sm font-semibold text-slate-700">0</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-xl">
                        <p class="text-xs text-slate-500 mb-1">Auto-Reconectar</p>
                        <p id="connectionAutoReconnect" class="text-sm font-semibold text-emerald-600">Ativo</p>
                    </div>
                </div>
                
                <div class="border-t border-slate-100 pt-4">
                    <h4 class="text-xs font-semibold text-slate-600 mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        ERROS RECENTES
                    </h4>
                    <div id="connectionErrors" class="space-y-2 max-h-40 overflow-y-auto">
                        <p class="text-xs text-slate-400 italic">Nenhum erro recente</p>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-slate-100 flex gap-2">
                <button onclick="resetReconnectCounter()" class="btn btn-secondary flex-1">
                    <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                    Resetar Contador
                </button>
                <button onclick="forceReconnect()" class="btn btn-primary flex-1">
                    <i data-lucide="power" class="w-4 h-4"></i>
                    For√ßar Reconex√£o
                </button>
            </div>
        </div>
    </div>

    <script src="lib-data-layer.js"></script>
    <script src="lib-chat-loader.js"></script>
    <script src="lib-anne-panel.js"></script>
    <script src="atendimentos.js"></script>
    <script>lucide.createIcons();</script>
</body>
</html>
