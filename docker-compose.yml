version: '3.3'
services:
  # ============================================================================
  # CRM App — Next.js (frontend :3000) + server.js (API :3001 interno)
  # Deploy no Easypanel como app "crm"
  # Container único com supervisord rodando ambos os processos
  # ============================================================================
  crm-app:
    build: .
    container_name: crm_app
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Servidor
      - NODE_ENV=production
      - PUBLIC_URL=https://cjota-crm.9eo9b2.easypanel.host

      # Next.js aponta para o backend interno
      - CRM_API_URL=http://localhost:3001

      # FacilZap API
      - FACILZAP_TOKEN=${FACILZAP_TOKEN}
      - SITE_BASE_URL=${SITE_BASE_URL:-https://seuloja.com.br}

      # Evolution API (rede interna do Easypanel ou URL pública)
      - EVOLUTION_URL=${EVOLUTION_URL:-https://evolution-api.cjota.site}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - INSTANCE_NAME=${INSTANCE_NAME:-Cjota}

      # N8N
      - N8N_URL=${N8N_URL:-https://cjota-n8n.9eo9b2.easypanel.host}
      - N8N_API_KEY=${N8N_API_KEY}

      # Supabase (opcional)
      - SUPABASE_URL=${SUPABASE_URL:-https://qmyeyiujmcdjzvcqkyoc.supabase.co}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}

      # OpenAI (Anny IA)
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Sessão
      - SESSION_SECRET=${SESSION_SECRET}

    volumes:
      - crm_data:/app/.crm-data
    
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  crm_data:
