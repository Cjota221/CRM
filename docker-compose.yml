version: '3.3'
services:
  # ============================================================================
  # CRM BACKEND - Servidor Node.js (server.js)
  # Deploy no Easypanel como app "crm"
  # ============================================================================
  crm-backend:
    build: .
    container_name: crm_backend
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Servidor
      - PORT=3000
      - NODE_ENV=production
      - PUBLIC_URL=https://cjota-crm.9eo9b2.easypanel.host

      # FacilZap API
      - FACILZAP_TOKEN=${FACILZAP_TOKEN}
      - SITE_BASE_URL=${SITE_BASE_URL:-https://seuloja.com.br}

      # Evolution API (rede interna do Easypanel ou URL pública)
      - EVOLUTION_URL=${EVOLUTION_URL:-https://evolution-api.cjota.site}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - INSTANCE_NAME=${INSTANCE_NAME:-Cjota}

      # N8N
      - N8N_URL=${N8N_URL:-https://cjota-n8n.9eo9b2.easypanel.host}
      - N8N_API_KEY=${N8N_API_KEY}

      # Supabase (opcional)
      - SUPABASE_URL=${SUPABASE_URL:-https://qmyeyiujmcdjzvcqkyoc.supabase.co}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}

      # Sessão
      - SESSION_SECRET=${SESSION_SECRET}

    volumes:
      - crm_data:/app/.crm-data
    
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/whatsapp/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  crm_data:
